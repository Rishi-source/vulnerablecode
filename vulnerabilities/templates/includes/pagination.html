<div class="pagination-controls mb-4">
  <div class="is-flex is-justify-content-center mb-3">
      <div class="select is-small {% if total_count < current_page_size %}is-disabled{% endif %}">
          <select id="page-size-selector" 
                  data-valid-sizes="{% for choice in page_size_choices %}{{ choice.value }}{% if not forloop.last %},{% endif %}{% endfor %}"
                  onchange="handlePageSizeChange(this)" 
                  {% if total_count < current_page_size %}disabled="disabled"{% endif %}>
              {% for choice in page_size_choices %}
                  <option value="{{ choice.value|stringformat:'i' }}" 
                          {% if choice.value == current_page_size %}selected{% endif %}>
                      {{ choice.label|escape }}
                  </option>
              {% endfor %}
          </select>
      </div>
  </div>

  {% if page_obj.paginator.num_pages > 1 %}
  <nav class="pagination is-centered" role="navigation" aria-label="pagination">
      {% if page_obj.has_previous %}
          <a href="?search={{ search|urlencode }}&page_size={{ current_page_size }}&page={{ page_obj.previous_page_number }}" 
             class="pagination-previous" rel="nofollow">Previous</a>
      {% else %}
          <button class="pagination-previous" disabled>Previous</button>
      {% endif %}

      {% if page_obj.has_next %}
          <a href="?search={{ search|urlencode }}&page_size={{ current_page_size }}&page={{ page_obj.next_page_number }}" 
             class="pagination-next" rel="nofollow">Next</a>
      {% else %}
          <button class="pagination-next" disabled>Next</button>
      {% endif %}
      
      <ul class="pagination-list">
          {% for page_num in page_range %}
              {% if page_num == '...' %}
                  <li><span class="pagination-ellipsis">&hellip;</span></li>
              {% else %}
                  <li>
                      <a href="?search={{ search|urlencode }}&page_size={{ current_page_size }}&page={{ page_num }}" 
                         class="pagination-link {% if page_num == page_obj.number|stringformat:'s' %}is-current{% endif %}"
                         aria-label="Go to page {{ page_num|escape }}"
                         rel="nofollow"
                         {% if page_num == page_obj.number|stringformat:'s' %}aria-current="page"{% endif %}>
                          {{ page_num|escape }}
                      </a>
                  </li>
              {% endif %}
          {% endfor %}
      </ul>
  </nav>
  {% endif %}
</div>

<style>
.select.is-disabled {
  opacity: 0.7;
  cursor: not-allowed;
}
.select.is-disabled select {
  cursor: not-allowed;
}
</style>

<script>
function handlePageSizeChange(selectElement) {
    if (!selectElement) return;
    const validSizes = selectElement.getAttribute('data-valid-sizes').split(',').map(size => parseInt(size, 10)).filter(size => !isNaN(size));
    const rawValue = selectElement.value;
    const pageSize = validSizes.includes(parseInt(rawValue, 10)) ? rawValue : validSizes[0];
    const currentUrl = new URL(window.location.href);
    const params = new URLSearchParams(currentUrl.search);
    params.set('page_size', pageSize);
    params.delete('page');
    for (const [key, value] of params.entries()) {
        params.set(key, value.replace(/[<>&'"]/g, ''));
    }
    currentUrl.search = params.toString();
    window.location.href = currentUrl.toString();
}
</script>